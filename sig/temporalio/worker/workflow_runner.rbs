module Temporalio
  class Worker
    class WorkflowRunner
      class Completion < Struct[untyped]
        attr_accessor resolve(): ^(untyped) -> untyped
        attr_accessor reject(): ^(Exception) -> untyped

        def self.new: (^(untyped) -> untyped resolve, ^(Exception) -> untyped reject) -> Completion
      end

      def initialize: (
        String namespace,
        String task_queue,
        singleton(Temporalio::Workflow) workflow_class,
        String run_id,
        Temporalio::Worker::SyncWorker worker,
        Temporalio::DataConverter converter,
        Temporalio::Interceptor::Chain[Temporalio::Interceptor::WorkflowInbound] inbound_interceptors,
        Temporalio::Interceptor::Chain[Temporalio::Interceptor::WorkflowOutbound] outbound_interceptors
      ) -> void
      def process: (Coresdk::WorkflowActivation::WorkflowActivation activation) -> Array[Coresdk::WorkflowCommands::WorkflowCommand]
      def push_command: (Coresdk::WorkflowCommands::WorkflowCommand command) -> Array[untyped]
      def add_completion: (Symbol type, ^(untyped) -> void resolve, ^(Exception) -> void reject) -> Integer
      def remove_completion: (Symbol type, Integer seq) -> bool
      def finished?: -> bool

      private

      @finished: bool

      attr_reader namespace: String
      attr_reader task_queue: String
      attr_reader workflow_class: singleton(Temporalio::Workflow)
      attr_reader run_id: String
      attr_reader worker: Temporalio::Worker::SyncWorker
      attr_reader converter: Temporalio::DataConverter
      attr_reader inbound_interceptors: Temporalio::Interceptor::Chain[Temporalio::Interceptor::WorkflowInbound]
      attr_reader outbound_interceptors: Temporalio::Interceptor::Chain[Temporalio::Interceptor::WorkflowOutbound]
      attr_reader commands: Array[Coresdk::WorkflowCommands::WorkflowCommand]
      attr_reader sequences: Hash[Symbol, Integer]
      attr_reader completions: Hash[Symbol, Hash[Integer, Temporalio::Worker::WorkflowRunner::Completion]]
      attr_reader fiber: Fiber?

      def order_jobs: (Array[Coresdk::WorkflowActivation::WorkflowActivationJob] jobs) -> Array[Coresdk::WorkflowActivation::WorkflowActivationJob]
      def apply: (Coresdk::WorkflowActivation::WorkflowActivationJob job) -> nil
      def apply_start_workflow: (Coresdk::WorkflowActivation::StartWorkflow job) -> untyped
      def apply_fire_timer: (Coresdk::WorkflowActivation::FireTimer job) -> untyped
      def generate_workflow_info: (Coresdk::WorkflowActivation::StartWorkflow) -> Temporalio::Workflow::Info
    end
  end
end
